"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function a(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(e,t,r){return t&&a(e.prototype,t),r&&a(e,r),e}}(),_reactNative=require("react-native");function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var __client_id=1,__client_secret="ocxO18rEHlJEaT4xCypPoAHbISmrrCR7BBEbqlaR",__host_api="http://30.30.30.226:8000/",Majax=function(){function t(){_classCallCheck(this,t),this.header=null,this.is_reload=!1;var e=__host_api||"";this.config={login:e+"oauth/token",refresh:e+"oauth/token"},this.request_fncs=null,this.request_url=null,this.request_type="",this.request_data=null,this.status_valid=[200,201,202,203,204,205,206],this.status_entity=[422],this.status_reload=[401]}return _createClass(t,[{key:"validate",value:function(t){var r=this;return _reactNative.AsyncStorage.getItem("authentication").then(function(e){return r.__validate(e,t)})}},{key:"__validate",value:function(e,t){t(!!e)}},{key:"createHeader",value:function(e){if(this.header&&delete this.header,this.header=new Headers,e){var t=JSON.parse(e);this.header.set("Authorization",t.token_type+" "+t.access_token)}}},{key:"logout",value:function(){this.access_token=null,this.refresh_token=null,this.token_type=null,this.valid_handle=null,this.reload_handle=null,this.error_handle=null,this.is_authenticate=!1,_reactNative.AsyncStorage.clear(),then(function(){return console.warn("logout")})}},{key:"requestReload",value:function(){switch(this.is_reload=!0,this.request_type){case"GET":this.get(this.request_url,this.request_fncs,this.request_data);break;case"POST":this.post(this.request_url,this.request_fncs,this.request_data);break;case"PUT":this.put(this.request_url,this.request_fncs,this.request_data);break;case"DELETE":this.delete(this.request_url,this.request_fncs)}}},{key:"__response",value:function(e){var t=this.request_fncs;t&&t.valid&&t.valid(e)}},{key:"__responseAjax",value:function(e){var t=this;if(e.ok)switch(this.contentType){case"text":e.text().then(function(e){return t.__response(e)});break;case"blob":e.blob().then(function(e){return t.__response(e)});break;case"arrayBuffer":e.arrayBuffer().then(function(e){return t.__response(e)});break;default:e.json().then(function(e){return t.__response(e)})}else 401===e.status&&!1===this.is_reload?this.oauthRefresh():(console.warn("Error inesperado en la petición response ajax"),console.warn(e),e.json().then(function(e){return t.__errorAjax(e)}))}},{key:"__errorAjax",value:function(e){var t=this.request_fncs;console.warn(e),t&&t.error&&t.error(e)}},{key:"get",value:function(t,r){var a=this,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;_reactNative.AsyncStorage.getItem("authentication").then(function(e){return a.__get(e,t,r,n)})}},{key:"__get",value:function(e,t,r){var a=this,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;if(this.createHeader(e),n)switch(t.lastIndexOf("?")<0&&(t+="?"),n.type){case"form":var s=new FormData(n.data).entries(),i=!0,o=!1,h=void 0;try{for(var u,c=s[Symbol.iterator]();!(i=(u=c.next()).done);i=!0){var _=u.value;"&"!==t.charAt(t.length-1)&&(t+="&"),t+=_[0]+"="+_[1]}}catch(e){o=!0,h=e}finally{try{!i&&c.return&&c.return()}finally{if(o)throw h}}break;case"formdata":var l=n.data.entries(),d=!0,f=!1,v=void 0;try{for(var p,y=l[Symbol.iterator]();!(d=(p=y.next()).done);d=!0){var k=p.value;"&"!==t.charAt(t.length-1)&&(t+="&"),t+=k[0]+"="+k[1]}}catch(e){f=!0,v=e}finally{try{!d&&y.return&&y.return()}finally{if(f)throw v}}break;case"json":for(var q in n.data)"&"!==t.charAt(t.length-1)&&(t+="&"),t+=q+"="+n.data[q]}var g=__host_api||"";this.is_reload||(t=g+t),this.request_fncs=r,this.request_type="GET",this.request_url=t,this.request_data=n,this.header.set("X-Requested-With","XMLHttpRequest"),fetch(t,{method:"GET",headers:this.header,mode:"cors",cache:"default"}).then(function(e){return a.__responseAjax(e)}).catch(function(e){return a.__errorAjax(e)})}},{key:"post",value:function(t,r){var a=this,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;_reactNative.AsyncStorage.getItem("authentication").then(function(e){return a.__post(e,t,r,n)})}},{key:"__post",value:function(e,t,r){var a=this,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;this.createHeader(e),this.request_type="POST",this.request_url=t,this.request_data=n,this.request_fncs=r;var s=__host_api||"";this.is_reload||(t=s+t);var i=null;if(this.header.set("X-Requested-With","XMLHttpRequest"),n)switch(n.type){case"file":var o=new FormData;o.append("file",n.data),i=o;break;case"form":var h=new FormData(n.data);body=h;break;case"formdata":i=n.data;break;case"json":this.header.set("Content-Type","application/json"),i=JSON.stringify(n.data);break;default:i=n.data}fetch(t,{method:"POST",headers:this.header,mode:"cors",cache:"default",body:i}).then(function(e){return a.__responseAjax(e)}).catch(function(e){return a.__errorAjax(e)})}},{key:"put",value:function(t,r){var a=this,n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;_reactNative.AsyncStorage.getItem("authentication").then(function(e){return a.__put(e,t,r,n)})}},{key:"__put",value:function(e,t,r){var a=this,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;this.createHeader(e),this.request_type="PUT",this.request_url=t,this.request_fncs=r,this.request_data=n;var s=__host_api||"";this.is_reload||(t=s+t);var i=null;if(this.header.set("X-Requested-With","XMLHttpRequest"),n)switch(n.type){case"file":var o=new FormData;o.append("file",n.data),i=o;break;case"form":i=new FormData(n.data);break;case"formdata":i=n.data;break;case"json":this.header.set("Content-Type","application/json"),i=JSON.stringify(n.data);break;default:i=n.data}fetch(t,{method:"PUT",headers:this.header,mode:"cors",cache:"default",body:i}).then(function(e){return a.__responseAjax(e)}).catch(function(e){return a.__errorAjax(e)})}},{key:"delete",value:function(t,r){var a=this;_reactNative.AsyncStorage.getItem("authentication").then(function(e){return a.__get(e,t,r,data)})}},{key:"__delete",value:function(e,t,r){var a=this;this.createHeader(e),this.request_type="DELETE",this.request_url=t,this.request_data=data,this.request_fncs=r;var n=__host_api||"";this.is_reload||(t=n+t),fetch(t,{method:"DELETE",headers:this.header,mode:"cors",cache:"default"}).then(function(e){return a.__responseAjax(e)}).catch(function(e){return a.__errorAjax(e)})}},{key:"oauth",value:function(e,t,r){var a=this;this.createHeader(null),this.request_fncs=r,this.header.set("X-Requested-With","XMLHttpRequest"),this.header.set("Content-Type","application/json"),this.header.set("Accept","application/json"),fetch(this.config.login,{method:"POST",headers:this.header,mode:"cors",cache:"default",body:JSON.stringify({grant_type:"password",client_id:__client_id,client_secret:__client_secret,username:e,password:t})}).then(function(e){return a.__responseOauth(e)}).catch(function(e){return a.__errorOauth(e)})}},{key:"__errorOauth",value:function(e){var t=this.request_fncs;t&&t.error&&t.error(e)}},{key:"__responseJsonOauth",value:function(e){var t=this;_reactNative.AsyncStorage.setItem("authentication",JSON.stringify(e)).then(function(){return t.__validOauth()})}},{key:"__validOauth",value:function(){var e=this.request_fncs;e&&e.valid&&e.valid()}},{key:"__responseOauth",value:function(e){var t=this;e.ok?e.json().then(function(e){return t.__responseJsonOauth(e)}):e.json().then(function(e){return t.__errorAjax(e)})}},{key:"oauthRefresh",value:function(){var t=this;_reactNative.AsyncStorage.getItem("authentication").then(function(e){return t.__oauthRefresh(e)})}},{key:"__oauthRefresh",value:function(e){var t=this;this.createHeader(e);var r=JSON.parse(e);this.header.set("X-Requested-With","XMLHttpRequest"),this.header.set("Content-Type","application/json"),this.header.set("Accept","application/json"),fetch(this.config.refresh,{method:"POST",headers:this.header,mode:"cors",cache:"default",body:JSON.stringify({grant_type:"refresh_token",client_id:__client_id,client_secret:__client_secret,refresh_token:r.refresh_token})}).then(function(e){return t.__responseRefresh(e)}).catch(function(e){return t.__errorAjax(e)})}},{key:"__responseJsonRefresh",value:function(e){var t=this;_reactNative.AsyncStorage.setItem("authentication",JSON.stringify(e)).then(function(){return t.requestReload()})}},{key:"__responseRefresh",value:function(e){var t=this;e.ok?e.json().then(function(e){return t.__responseJsonRefresh(e)}):(console.warn("Error inesperado en la petición"),console.warn(e))}}]),t}();exports.default=Majax;