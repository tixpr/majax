"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function s(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(e,t,r){return t&&s(e.prototype,t),r&&s(e,r),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Majax=function(){function r(){_classCallCheck(this,r),this.getAutentication(),this.header=null,this.is_reload=!1;var e=localStorage.getItem("credentials"),t="";e&&(t=JSON.parse(e).host_api||""),this.config={login:t+"oauth/token",refresh:t+"oauth/token"},this.request_fncs=null,this.request_url=null,this.request_type="",this.request_data=null}return _createClass(r,null,[{key:"setConfig",value:function(e,t,r){localStorage.setItem("credentials",JSON.stringify({client_id:e,client_secret:t,host_api:r}))}}]),_createClass(r,[{key:"createHeader",value:function(){self.fetch?(this.header&&delete this.header,this.header=new Headers,this.is_authenticate&&this.header.set("Authorization",this.token_type+" "+this.access_token)):alert("Fetch no soportado, Favor de actualizar su navegador")}},{key:"getAutentication",value:function(){if(null!=localStorage.getItem("authentication")){this.is_authenticate=!0;var e=JSON.parse(localStorage.getItem("authentication"));this.access_token=e.access_token,this.refresh_token=e.refresh_token,this.token_type=e.token_type}else this.is_authenticate=!1}},{key:"requestErase",value:function(){this.request_fncs=null,this.request_url=null,this.request_type="",this.request_data=null}},{key:"logout",value:function(){this.access_token=null,this.refresh_token=null,this.token_type=null,this.valid_handle=null,this.reload_handle=null,this.error_handle=null,this.is_authenticate=!1,localStorage.removeItem("authentication")}},{key:"requestErase",value:function(){this.request_fncs=null,this.request_url=null,this.request_type="",this.request_data=null}},{key:"requestReload",value:function(){switch(this.is_reload=!0,this.request_type){case"GET":this.get(this.request_url,this.request_fncs,this.request_data);break;case"POST":this.post(this.request_url,this.request_fncs,this.request_data);break;case"PUT":this.put(this.request_url,this.request_fncs,this.request_data);break;case"DELETE":this.delete(this.request_url,this.request_fncs)}}},{key:"__response",value:function(e){console.info("iniciando pasado de la respuesta");var t=this.request_fncs;t&&t.valid&&t.valid(e)}},{key:"__responseAjax",value:function(e){var t=this;if(console.info(e.status),e.ok)switch(this.contentType){case"text":e.text().then(function(e){return t.__response(e)});break;case"blob":e.blob().then(function(e){return t.__response(e)});break;case"arrayBuffer":e.arrayBuffer().then(function(e){return t.__response(e)});break;default:console.info("interpretando json"),e.json().then(function(e){return t.__response(e)})}else 401===e.status&&!1===this.is_reload?this.oauth_refresh():(console.warn("Error inesperado en la petición response ajax"),console.warn(e),e.json().then(function(e){return t.__errorAjax(e)}))}},{key:"__errorAjax",value:function(e){var t=this.request_fncs;console.error(e),t&&t.error&&t.error(e)}},{key:"get",value:function(e,t){var r=this,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;if(this.createHeader(),s)switch(e.lastIndexOf("?")<0&&(e+="?"),s.type){case"form":var a=new FormData(s.data).entries(),n=!0,i=!1,o=void 0;try{for(var h,u=a[Symbol.iterator]();!(n=(h=u.next()).done);n=!0){var c=h.value;"&"!==e.charAt(e.length-1)&&(e+="&"),e+=c[0]+"="+c[1]}}catch(e){i=!0,o=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw o}}break;case"formdata":var l=s.data.entries(),_=!0,f=!1,d=void 0;try{for(var p,y=l[Symbol.iterator]();!(_=(p=y.next()).done);_=!0){var v=p.value;"&"!==e.charAt(e.length-1)&&(e+="&"),e+=v[0]+"="+v[1]}}catch(e){f=!0,d=e}finally{try{!_&&y.return&&y.return()}finally{if(f)throw d}}break;case"json":for(var k in s.data)"&"!==e.charAt(e.length-1)&&(e+="&"),e+=k+"="+s.data[k]}e=(__host_api||"")+e,this.request_fncs=t,this.request_type="GET",this.request_url=e,this.request_data=s,this.header.set("X-Requested-With","XMLHttpRequest"),fetch(e,{method:"GET",headers:this.header,mode:"cors",cache:"default"}).then(function(e){return r.__responseAjax(e)}).catch(function(e){return r.__errorAjax(e)})}},{key:"post",value:function(e,t){var r=this,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;this.createHeader(),this.request_fncs=t,this.request_type="POST",this.request_url=e,this.request_data=s,e=(__host_api||"")+e;var a=null;if(this.header.set("X-Requested-With","XMLHttpRequest"),s)switch(s.type){case"file":var n=new FormData;n.append("file",s.data),a=n;break;case"form":a=new FormData(s.data);break;case"formdata":a=s.data;break;case"json":this.header.set("Content-Type","application/json"),a=JSON.stringify(s.data);break;default:a=s.data}fetch(e,{method:"POST",headers:this.header,mode:"cors",cache:"default",body:a}).then(function(e){return r.__responseAjax(e)}).catch(function(e){return r.__errorAjax(e)})}},{key:"put",value:function(e,t){var r=this,s=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;this.createHeader(),this.request_fncs=t,this.request_type="PUT",this.request_url=e,this.request_data=s,e=(__host_api||"")+e;var a=null;if(this.header.set("X-Requested-With","XMLHttpRequest"),s)switch(s.type){case"file":var n=new FormData;n.append("file",s.data),a=n;break;case"form":a=new FormData(s.data);break;case"formdata":a=s.data;break;case"json":this.header.set("Content-Type","application/json"),a=JSON.stringify(s.data);break;default:a=s.data}fetch(e,{method:"PUT",headers:this.header,mode:"cors",cache:"default",body:a}).then(function(e){return r.__responseAjax(e)}).catch(function(e){return r.__errorAjax(e)})}},{key:"delete",value:function(e,t){var r=this;this.createHeader(),this.request_fncs=t,this.request_type="DELETE",this.request_url=e,this.request_data=data,e=(__host_api||"")+e,fetch(e,{method:"DELETE",headers:this.header,mode:"cors",cache:"default"}).then(function(e){return r.__responseAjax(e)}).catch(function(e){return r.__errorAjax(e)})}},{key:"oauth",value:function(e,t,r){var s=this;this.createHeader(),this.request_fncs=r,this.header.set("X-Requested-With","XMLHttpRequest"),this.header.set("Content-Type","application/json");var a=localStorage.getItem("credentials");if(a){var n=JSON.parse(a);fetch(this.config.login,{method:"POST",headers:this.header,mode:"cors",cache:"default",body:JSON.stringify({grant_type:"password",client_id:n.client_id,client_secret:n.client_secret,username:e,password:t})}).then(function(e){return s.__responseOauth(e)}).catch(function(e){return s.__errorOauth(e)})}else alert("no existe información de usuario del API")}},{key:"__errorOauth",value:function(e){var t=this.request_fncs;console.info("Error oauth->"+e),t&&t.error&&t.error(e)}},{key:"__responseOauth",value:function(e){var t=this;e.ok?e.json().then(function(e){return t.__responseJsonOauth(e)}):500<=e.status&&e.status<=600?this.__errorAjax({message:e.statusText,error:e.status}):e.json().then(function(e){return t.__errorAjax(e)})}},{key:"__responseJsonOauth",value:function(e){localStorage.setItem("authentication",JSON.stringify(e)),this.access_token=e.access_token,this.refresh_token=e.refresh_token,this.token_type=e.token_type,this.is_authenticate=!0;var t=this.request_fncs;t&&t.valid&&t.valid(e)}},{key:"oauth_refresh",value:function(){var t=this;this.createHeader(),this.header.set("X-Requested-With","XMLHttpRequest"),this.header.set("Content-Type","application/json"),this.header.set("Accept","application/json");var e=localStorage.getItem("credentials");if(e){var r=JSON.parse(e);fetch(this.config.refresh,{method:"POST",headers:this.header,mode:"cors",cache:"default",body:JSON.stringify({grant_type:"refresh_token",client_id:r.client_id,client_secret:r.client_secret,refresh_token:this.refresh_token})}).then(function(e){return t.__responseRefresh(e)}).catch(function(e){return t.__errorAjax(e)})}else alert("no existe información de usuario del API")}},{key:"__responseRefresh",value:function(e){var t=this;e.ok?e.json().then(function(e){return t.__responseJsonRefresh(e)}):e.json().then(function(e){return t.__errorAjax(e)})}},{key:"__responseJsonRefresh",value:function(e){localStorage.setItem("authentication",JSON.stringify(e)),this.access_token=e.access_token,this.refresh_token=e.refresh_token,this.token_type=e.token_type,this.is_authenticate=!0,this.requestReload()}}]),r}();exports.default=Majax;